@model ViewmMODeElMASTER
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
@section style
{
    <link href="~/css/site.css" rel="stylesheet" />
}
<div class="page-wrapper">
	<div class="content">
		<div class="row">
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash1.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@ViewBag.totaallpurches">$@ViewBag.totaallpurches</span></h5>
						<h6>إجمالي المشتريات </h6>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget dash1 w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash2.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@ViewBag.TotalAmount">$@ViewBag.TotalAmount</span></h5>
						<h6>إجمالي المبيعات </h6>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget dash2 w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash3.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>#<span class="counters" data-count="@ViewBag.Quantity">$@ViewBag.Quantity</span></h5>
						<h6>اجمالي الكمية</h6>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget dash3 w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash4.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@ViewBag.totalExch">$@ViewBag.totalExch</span></h5>
						<h6>إجمالي المصاريف </h6>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget dash1 w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash2.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@ViewBag.Profit">$@ViewBag.Profit</span></h5>
						<h6>إجمالي الربح </h6>
					</div>
				</div>
			</div>
@* 			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash1.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@ViewBag.totaallpurches">$@ViewBag.totaallpurches</span></h5>
						<h6>إجمالي الذمم </h6>
					</div>
				</div>
			</div> *@
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-widget w-100">
					<div class="dash-widgetimg">
						<span><img src="~/AdminEn/assets/img/icons/dash1.svg" alt="img"></span>
					</div>
					<div class="dash-widgetcontent">
						<h5>$<span class="counters" data-count="@TempData["totalDebtor"]">$@TempData["totalDebtor"]</span></h5>
						<h6>إجمالي الذمم </h6>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-count das2 bg-danger-gradient">
					<div class="dash-counts">
						<h4>@ViewBag.contstaff </h4>
						<h5>الموظفين</h5>
					</div>
					<div class="dash-imgs">
						<i data-feather="user"></i>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-count">
					<div class="dash-counts">
						<h4>@ViewBag.cont </h4>
						<h5>العملاء</h5>
					</div>
					<div class="dash-imgs">
						<i data-feather="user"></i>
					</div>
				</div>
			</div>
			<div class="col-xl-2 col-sm-6 col-12 d-flex">
				<div class="dash-count das1">
					<div class="dash-counts">
						<h4>@ViewBag.contsupler</h4>
						<h5>موردين</h5>
					</div>
					<div class="dash-imgs">
						<i data-feather="user-check"></i>
					</div>
				</div>
			</div>

			<div class="col-xl-3 col-sm-6 col-12 d-flex">
				<div class="dash-count das2">
					<div class="dash-counts">
						<h4>@ViewBag.maxpurs</h4>
						<h5>تسلسل فواتير الشراء</h5>
					</div>
					<div class="dash-imgs">
						<img src="~/AdminEn/assets/img/icons/file-text-icon-01.svg" class="img-fluid" alt="icon">
					</div>
				</div>
			</div>
			<div class="col-xl-3 col-sm-6 col-12 d-flex">
				<div class="dash-count das3">
					<div class="dash-counts">
						<h4>@ViewBag.max</h4>
						<h5>تسلسل فواتير البيع </h5>
					</div>
					<div class="dash-imgs">
						<i data-feather="file"></i>
					</div>
				</div>
			</div>
		</div>
		<!-- Button trigger modal -->
		<div class="row">
			<div class="col-xl-7 col-sm-12 col-12 d-flex">
				<div class="card flex-fill">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h5 class="card-title mb-0">الذمم</h5>				
					</div>
					<div style="overflow-x: auto; width: 100%;">
						<canvas id="myChart" style="min-width: 1200px; height: 300px;"></canvas>
					</div>
				</div>
			</div>
			<div class="col-xl-5 col-sm-12 col-12 d-flex">
				<div class="card flex-fill default-cover mb-4">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h4 class="card-title mb-0">المنتجات الاكثر مبيعا </h4>
						<div class="view-all-link">
							<a href="javascript:void(0);" class="view-all d-flex align-items-center">
								View All<span class="ps-2 d-flex align-items-center"><i data-feather="arrow-right" class="feather-16"></i></span>
							</a>
						</div>
					</div>
					<div class="card-body">
						<div class="table-responsive dataview">
							<table class="table dashboard-recent-products">
								<thead>
									<tr>
										
										<th>المنتج</th>
										<th>اجمالي البيع</th>
										<th>اجمالي الكمية</th>
									</tr>
								</thead>
							
								<tbody class="scrollable-body">
									@foreach (var item in ViewBag.TopSellingItems)
									{
										<tr>
											
											<td class="productimgname">
												<a href="product-list.html" class="product-img">
													<img src="@Url.Content("~/Images/Home/" + item.ProductImage)" alt="product">
													<!-- هنا يمكن تعديل الرابط للصورة الفعلية -->
												</a>
												<a href="product-list.html">@item.ProductName</a> <!-- عرض اسم المنتج -->
											</td>
											<td>@item.TotalSales</td> <!-- عرض إجمالي المبيعات -->
											<td>@item.SalesCount</td> <!-- عرض إجمالي المبيعات -->
										</tr>
									}				
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header">
				<h4 class="card-title">المستخدمين النشطين</h4>
			</div>
			<div class="card-body">
				<div class="table-responsive dataview">
					<table class="table dashboard-expired-products" id="online-users-table">
						<thead>
							<tr>
								<th class="no-sort">
									<label class="checkboxs">
										<input type="checkbox" id="select-all">
										<span class="checkmarks"></span>
									</label>
								</th>
								<th>المستخدم</th>
								<th>البريد الاكتروني</th>
								<th>رقم الهاتف</th>
								<th class="no-sort">Action</th>
							</tr>
						</thead>
						<tbody id="onlineUsersTableBody">
							<!-- سيتم ملء البيانات هنا بواسطة JavaScript -->
						</tbody>
					</table>
				</div>
			</div>
		</div>


		
	</div>
</div>

@section scripts {
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script>
		$(document).ready(function () {
			var labels = @Html.Raw(Json.Serialize(ViewBag.Labels));
			var data = @Html.Raw(Json.Serialize(ViewBag.Data));
			var ctx = document.getElementById('myChart').getContext('2d');
			var chartData = {
				labels: labels,
				datasets: [{
					label: 'الذمم',
					data: data,
					backgroundColor: data.map(value => value < 0 ? 'rgba(200, 0, 0, 0.8)' : 'rgba(0, 76, 153, 0.8)'), 
					borderColor: data.map(value => value < 0 ? 'rgba(150, 0, 0, 1)' : 'rgba(0, 50, 100, 1)'),
					borderWidth: 2
				}]
			};
			var myChart = new Chart(ctx, {
				type: 'bar',
				data: chartData,
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						x: {
							ticks: {
								autoSkip: false, 
								maxRotation: 45,
								minRotation: 45
							}
						},
						y: {
							beginAtZero: true
						}
					},
					plugins: {
						legend: {
							position: 'top',
						},
						tooltip: {
							mode: 'index',
							intersect: false,
						}
					}
				}
			});
		});
	</script>

	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
	<script>
		const connection = new signalR.HubConnectionBuilder()
			.withUrl("/userHub")
			.build();

		// عند الاتصال بالمستخدمين الجدد
		connection.on("UserConnected", function (users) {
			updateOnlineUsers(users);
		});

		// عند قطع الاتصال بالمستخدمين
		connection.on("UserDisconnected", function (users) {
			updateOnlineUsers(users);
		});

		// تحديث قائمة المستخدمين المتصلين
		function updateOnlineUsers(users) {
			const tableBody = document.getElementById("onlineUsersTableBody");
			tableBody.innerHTML = ""; // مسح البيانات الحالية

			users.forEach(user => {
				const row = document.createElement("tr");

				// خلية الاختيار
				const checkboxCell = document.createElement("td");
				checkboxCell.innerHTML = `
							<label class="checkboxs">
								<input type="checkbox">
								<span class="checkmarks"></span>
							</label>
						`;
				row.appendChild(checkboxCell);

				// اسم المستخدم
				const nameCell = document.createElement("td");
				nameCell.innerHTML = `
							<div class="productimgname">
								<a href="javascript:void(0);" class="product-img stock-img">
									<img src="/Images/Users/${user.imageUser}" alt="user-image"> <!-- صورة المستخدم -->
								</a>
								<a href="javascript:void(0);">${user.userName}</a> <!-- عرض اسم المستخدم -->
							</div>
						`;
				row.appendChild(nameCell);

				// البريد الإلكتروني
				const emailCell = document.createElement("td");
				emailCell.innerHTML = `<a href="mailto:${user.email}">${user.email}</a>`; // عرض البريد الإلكتروني
				row.appendChild(emailCell);

				// رقم الهاتف
				const phoneCell = document.createElement("td");
				phoneCell.textContent = user.phoneNumber; // عرض رقم الهاتف
				row.appendChild(phoneCell);

				// الإجراءات
				const actionCell = document.createElement("td");
				actionCell.classList.add("action-table-data");
				actionCell.innerHTML = `
							<div class="edit-delete-action">
								<a class="me-2 p-2" href="#">
									<i data-feather="edit" class="feather-edit"></i>
								</a>
								<a class="confirm-text p-2" href="javascript:void(0);">
									<i data-feather="trash-2" class="feather-trash-2"></i>
								</a>
							</div>
						`;
				row.appendChild(actionCell);

				tableBody.appendChild(row); // إضافة السطر إلى الجدول
			});
		}

		// بدء الاتصال
		connection.start().catch(err => console.error(err.toString()));
	</script>




}